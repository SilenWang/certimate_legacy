name: basebuild

on:
  push:
    paths:
      - '.github/workflows/*'

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.11.0

      # - name: Set up Go
      #   uses: actions/setup-go@v5
      #   with:
      #     go-version: ">=1.22.5"

      - name: Build Admin dashboard UI
        run: npm --prefix=./ui ci && npm --prefix=./ui run build
      
      - name: Download latest release from go-win7
        uses: robinraju/release-downloader@v1.11
        with:
          repository: 'XTLS/go-win7'
          latest: true
          fileName: '*linux-amd64.zip'
          out-file-path: 'go_win7'
          extract: true

      - name: Build Go Binary
        working-directory: ./
        run: |
          echo "${{ github.workspace }}/go_win7" >> $GITHUB_PATH
          make

      - name: Release
        uses: ncipollo/release-action@v1.15.0
        with:
          draft: false
          generateReleaseNotes: true  #自动生成发行说明。
          owner: "SilenWang"
          repo: "certimate_win7"
          artifacts: '${{ github.workspace }}/build/*'
          name: ${{ github.sha }}